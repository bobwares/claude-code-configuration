---
name: makefile-gen
description: Generate a Makefile with targets for tests, Docker, and local dev. Run manually or after /project-init.
triggers:
  - after project-init completes
  - when user asks for a Makefile
  - when setting up local development
---

# Makefile Generator

Generate a stack-aware Makefile with targets for running tests, starting Docker containers, and launching frontend/backend services locally.

The Makefile stays at project root and runs commands in the `app/` directory.

---

## How to Invoke

```
/makefile-gen
/makefile-gen stack=nextjs+nestjs+drizzle
```

Or called automatically after `/project-init` completes.

---

## Step 1: Detect Stack

If no stack argument provided, detect from project structure:

```bash
# Check for Next.js
[ -d "app/web" ] && [ -f "app/web/package.json" ] && NEXTJS=true

# Check for NestJS
[ -d "app/api" ] && [ -f "app/api/nest-cli.json" ] && NESTJS=true

# Check for Spring Boot
[ -d "app/services/enterprise" ] && [ -f "app/services/enterprise/pom.xml" ] && SPRING=true

# Check for Drizzle
[ -d "app/packages/database" ] && [ -f "app/packages/database/drizzle.config.ts" ] && DRIZZLE=true
```

---

## Step 2: Generate Makefile

Write `Makefile` to project root with all detected targets.

### Base Template (Always Include)

```makefile
# Generated by agentic-pipeline /makefile-gen
# Stack: <detected stack>
# Date: <timestamp>

# App directory (all node/pnpm commands run here)
APP_DIR := app

.PHONY: help install dev build test lint typecheck clean

# Default target
help:
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

#---------------------------------------------------------------------------
# Setup
#---------------------------------------------------------------------------

install: ## Install all dependencies
	cd $(APP_DIR) && pnpm install

clean: ## Clean build artifacts and node_modules
	rm -rf $(APP_DIR)/node_modules $(APP_DIR)/api/node_modules $(APP_DIR)/web/node_modules
	rm -rf $(APP_DIR)/packages/*/node_modules
	rm -rf $(APP_DIR)/web/.next $(APP_DIR)/api/dist $(APP_DIR)/packages/*/dist
	rm -rf $(APP_DIR)/services/*/target
	rm -rf $(APP_DIR)/.turbo

#---------------------------------------------------------------------------
# Development
#---------------------------------------------------------------------------

dev: ## Start all services in development mode
	cd $(APP_DIR) && pnpm dev

#---------------------------------------------------------------------------
# Quality
#---------------------------------------------------------------------------

test: ## Run all tests
	cd $(APP_DIR) && pnpm test

lint: ## Run linters
	cd $(APP_DIR) && pnpm lint

typecheck: ## Run TypeScript type checking
	cd $(APP_DIR) && pnpm typecheck

build: ## Build all packages
	cd $(APP_DIR) && pnpm build

verify: lint typecheck test build ## Run full verification (lint + typecheck + test + build)
```

### Docker Targets (Always Include)

```makefile
#---------------------------------------------------------------------------
# Docker
#---------------------------------------------------------------------------

.PHONY: docker-up docker-down docker-logs docker-ps

docker-up: ## Start all Docker services (detached)
	cd $(APP_DIR) && docker compose up -d

docker-down: ## Stop all Docker services
	cd $(APP_DIR) && docker compose down

docker-logs: ## Tail logs from all Docker services
	cd $(APP_DIR) && docker compose logs -f

docker-ps: ## Show running Docker services
	cd $(APP_DIR) && docker compose ps

docker-reset: docker-down ## Reset Docker (stop + remove volumes)
	cd $(APP_DIR) && docker compose down -v
	cd $(APP_DIR) && docker compose up -d
```

### If `nextjs` detected → Add Web Targets

```makefile
#---------------------------------------------------------------------------
# Frontend (Next.js)
#---------------------------------------------------------------------------

.PHONY: dev-web build-web test-web

dev-web: ## Start Next.js development server
	cd $(APP_DIR) && pnpm --filter web dev

build-web: ## Build Next.js for production
	cd $(APP_DIR) && pnpm --filter web build

test-web: ## Run Next.js tests
	cd $(APP_DIR) && pnpm --filter web test

start-web: ## Start Next.js production server
	cd $(APP_DIR) && pnpm --filter web start
```

### If `nestjs` detected → Add API Targets

```makefile
#---------------------------------------------------------------------------
# Backend (NestJS)
#---------------------------------------------------------------------------

.PHONY: dev-api build-api test-api

dev-api: ## Start NestJS development server
	cd $(APP_DIR) && pnpm --filter api dev

build-api: ## Build NestJS for production
	cd $(APP_DIR) && pnpm --filter api build

test-api: ## Run NestJS tests
	cd $(APP_DIR) && pnpm --filter api test

start-api: ## Start NestJS production server
	cd $(APP_DIR) && pnpm --filter api start:prod
```

### If `spring` detected → Add Enterprise Targets

```makefile
#---------------------------------------------------------------------------
# Enterprise (Spring Boot)
#---------------------------------------------------------------------------

.PHONY: dev-enterprise build-enterprise test-enterprise

dev-enterprise: ## Start Spring Boot with hot reload
	cd $(APP_DIR)/services/enterprise && mvn spring-boot:run

build-enterprise: ## Build Spring Boot JAR
	cd $(APP_DIR)/services/enterprise && mvn clean package -DskipTests

test-enterprise: ## Run Spring Boot tests
	cd $(APP_DIR)/services/enterprise && mvn test

start-enterprise: ## Run Spring Boot JAR
	java -jar $(APP_DIR)/services/enterprise/target/*.jar
```

### If `drizzle` detected → Add Database Targets

```makefile
#---------------------------------------------------------------------------
# Database (Drizzle)
#---------------------------------------------------------------------------

.PHONY: db-generate db-migrate db-studio db-push db-reset

db-generate: ## Generate Drizzle migrations
	cd $(APP_DIR) && pnpm db:generate

db-migrate: ## Run Drizzle migrations
	cd $(APP_DIR) && pnpm db:migrate

db-studio: ## Open Drizzle Studio
	cd $(APP_DIR) && pnpm db:studio

db-push: ## Push schema changes (dev only)
	cd $(APP_DIR) && pnpm --filter database db:push

db-reset: docker-reset db-migrate ## Reset database (drop + recreate + migrate)
```

### Convenience Compound Targets

```makefile
#---------------------------------------------------------------------------
# Convenience
#---------------------------------------------------------------------------

.PHONY: setup fresh all

setup: install docker-up db-migrate ## Full setup: install deps, start Docker, run migrations

fresh: clean install docker-reset db-migrate ## Fresh start: clean, install, reset DB

# Start everything needed for development
all: docker-up ## Start Docker and all dev servers
	@echo "Starting all services..."
	@make -j3 dev-web dev-api 2>/dev/null || make dev
```

---

## Step 3: Report

After generating the Makefile:

```
✅ Makefile generated

Stack detected:
  ✓ Next.js (app/web/)
  ✓ NestJS (app/api/)
  ✓ Drizzle (app/packages/database/)
  ✗ Spring Boot (not found)

Targets available:
  Setup:    make install, make setup, make fresh
  Dev:      make dev, make dev-web, make dev-api
  Docker:   make docker-up, make docker-down, make docker-logs
  Database: make db-migrate, make db-studio, make db-reset
  Quality:  make test, make lint, make typecheck, make verify
  Build:    make build, make build-web, make build-api

Run `make help` for full list.
```

---

## Full Example Output

For a `nextjs+nestjs+drizzle` stack:

```makefile
# Generated by agentic-pipeline /makefile-gen
# Stack: nextjs, nestjs, drizzle
# Date: 2026-02-24T23:05:24Z

# App directory (all node/pnpm commands run here)
APP_DIR := app

.PHONY: help install dev build test lint typecheck clean
.PHONY: docker-up docker-down docker-logs docker-ps docker-reset
.PHONY: dev-web build-web test-web start-web
.PHONY: dev-api build-api test-api start-api
.PHONY: db-generate db-migrate db-studio db-push db-reset
.PHONY: setup fresh all

#===========================================================================
# Help
#===========================================================================

help:
	@echo ""
	@echo "  Makefile for claude-code-configuration"
	@echo "  Stack: nextjs, nestjs, drizzle"
	@echo ""
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

#===========================================================================
# Setup
#===========================================================================

install: ## Install all dependencies
	cd $(APP_DIR) && pnpm install

clean: ## Clean build artifacts and node_modules
	rm -rf $(APP_DIR)/node_modules $(APP_DIR)/api/node_modules $(APP_DIR)/web/node_modules
	rm -rf $(APP_DIR)/packages/*/node_modules
	rm -rf $(APP_DIR)/web/.next $(APP_DIR)/api/dist $(APP_DIR)/packages/*/dist
	rm -rf $(APP_DIR)/.turbo coverage

#===========================================================================
# Development
#===========================================================================

dev: ## Start all services in development mode
	cd $(APP_DIR) && pnpm dev

dev-web: ## Start Next.js development server (port 3000)
	cd $(APP_DIR) && pnpm --filter web dev

dev-api: ## Start NestJS development server (port 3001)
	cd $(APP_DIR) && pnpm --filter api dev

#===========================================================================
# Docker
#===========================================================================

docker-up: ## Start all Docker services (detached)
	cd $(APP_DIR) && docker compose up -d

docker-down: ## Stop all Docker services
	cd $(APP_DIR) && docker compose down

docker-logs: ## Tail logs from all Docker services
	cd $(APP_DIR) && docker compose logs -f

docker-ps: ## Show running Docker services
	cd $(APP_DIR) && docker compose ps

docker-reset: ## Reset Docker (stop + remove volumes + restart)
	cd $(APP_DIR) && docker compose down -v
	cd $(APP_DIR) && docker compose up -d

#===========================================================================
# Database (Drizzle)
#===========================================================================

db-generate: ## Generate Drizzle migrations from schema
	cd $(APP_DIR) && pnpm db:generate

db-migrate: ## Run pending Drizzle migrations
	cd $(APP_DIR) && pnpm db:migrate

db-studio: ## Open Drizzle Studio GUI
	cd $(APP_DIR) && pnpm db:studio

db-push: ## Push schema changes directly (dev only, no migration)
	cd $(APP_DIR) && pnpm --filter database db:push

db-reset: docker-reset db-migrate ## Reset database (drop + recreate + migrate)

#===========================================================================
# Quality
#===========================================================================

test: ## Run all tests
	cd $(APP_DIR) && pnpm test

test-web: ## Run Next.js tests only
	cd $(APP_DIR) && pnpm --filter web test

test-api: ## Run NestJS tests only
	cd $(APP_DIR) && pnpm --filter api test

lint: ## Run ESLint on all packages
	cd $(APP_DIR) && pnpm lint

typecheck: ## Run TypeScript type checking
	cd $(APP_DIR) && pnpm typecheck

verify: lint typecheck test build ## Full verification pipeline

#===========================================================================
# Build
#===========================================================================

build: ## Build all packages for production
	cd $(APP_DIR) && pnpm build

build-web: ## Build Next.js for production
	cd $(APP_DIR) && pnpm --filter web build

build-api: ## Build NestJS for production
	cd $(APP_DIR) && pnpm --filter api build

start-web: ## Start Next.js production server
	cd $(APP_DIR) && pnpm --filter web start

start-api: ## Start NestJS production server
	cd $(APP_DIR) && pnpm --filter api start:prod

#===========================================================================
# Convenience
#===========================================================================

setup: install docker-up db-migrate ## Full setup: install, Docker, migrate

fresh: clean install docker-reset db-migrate ## Fresh start: clean everything, reinstall

all: docker-up dev ## Start Docker and all dev servers
```

---

## Integration with project-init

When `/project-init` completes, it should suggest:

```
Next: Run `/makefile-gen` to create a Makefile for easy development.
```

Or the `/execute` pipeline can call this skill automatically after scaffolding.
