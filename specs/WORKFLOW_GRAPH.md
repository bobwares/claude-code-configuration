# Workflow Graph

The rebuild workflow is a linear DAG derived from `docs/rebuild-guide.md` (8 turns) and the detailed turn contexts in `docs/plan-mode-driver.md`. Each turn consumes the artifacts produced by prior turns, runs the commands in `spec/COMMANDS.md`, records outputs under `ai/agentic-pipeline/turns`, and validates the layers listed in the guide before moving forward.

| Stage | Inputs | Actions | Outputs | Validation | Failure handling |
| --- | --- | --- | --- | --- | --- |
| Pre-flight | Host prereqs: Java 21, Node 20, npm 10, Docker 24+, Git (per `docs/rebuild-guide.md` Pre-Requisites). | Ensure `JAVA_HOME` is set (`/usr/libexec/java_home -v 21`) and `./mvnw -v`, `node -v`, `npm -v`, `docker -v`. | Environment ready for turns. | Pre-flight checklist (manual). | Halt until tooling is installed/configured. |
| Turn 1 – Project scaffolding | Empty repo + PRD (`docs/PRD.md`). | Run `npx create-next-app` with the exact flags, populate `ui/` structure, install all UI dependencies, configure `next.config.ts` and `globals.css`, add shadcn components, finalize `api/pom.xml`, `application*.yml`, `Makefile`. | Clean scaffolding: `ui/` tree, `api/` project, `db/schema` placeholder, `docs/*` references. | `cd api && ./mvnw compile`, `cd ui && npm run build`, `globals.css` import style, `next.config.ts` transpilePackages, `application.yml` contains `open-in-view`, shadcn components installed (`docs/rebuild-guide.md`, Turn 1 validation). | Fix errors (dependency install, configuration) before next turn; rerun commands until pass. |
| Turn 2 – Backend domain | Scaffolding + schema doc. | Implement entities, enums (DriveType, ConnectionStatus, CrawlStatus, MetadataSource with VIDEO), repositories, filesystem providers (`api/src/main/java/com/picturemodel/domain`, `infrastructure`). | Domain objects, repository interfaces, DB constraints (mirroring `db/schema.sql`). | `./mvnw test` (Turn 2 validation) and H2 CHECK constraints (no constraint failures as demanded). | If H2 fails, adjust column definitions per `docs/plan-mode-driver.md` Turn 2 (e.g., `columnDefinition = "VARCHAR(20)"`). |
| Turn 3 – Backend services | Domain layer + configs. | Build services (CredentialEncryption, Drive, Crawler, Exif/Video metadata, Thumbnail, Image, Tag, WebSocketEvent) plus configs (Async, Cors, Jackson, Jasypt, Jpa, WebSocket). | Business logic for crawls, metadata extraction, thumbnail creation, streaming, DTO mappings. | `./mvnw test` (Turn 3 validation) covering services and exception classes; logging of `ClientAbortException` handled per `docs/rebuild-guide.md`. | Fix failing service tests/transaction issues before proceeding; record exceptions via ADR if limitations (static ConcurrentHashMap). |
| Turn 4 – Backend API | Services + DTO lists. | Create controllers (Drive, Image, File, Tag, Crawler, System), DTOs (request/response), exception handler, relay WebSocket config, connect to services. | REST and WebSocket surface (`/api/drives`, `/api/images`, `/api/files`, `/topic/*`). | API validation (per Turn 4 in `docs/rebuild-guide.md`), ensures all DTOs exist and streaming handlers catch IOExceptions. | Re-run backend tests, ensure JSON schema coverage matches `docs/schemas`. |
| Turn 5 – Frontend foundation | API contract (`docs/schemas`), DTOs, services. | Implement `lib/api-client`, `lib/utils`, `lib/media-utils`, `types`, Zustand store, hooks (`use-drives`, `use-images`, `use-tags`, `use-crawler`, `use-websocket`, `use-debounce`). | Shared hooks and abstractions used by Turn 6/7 components. | `npm run lint` (ensures exported utilities exist) and `npm run test` for hook coverage. | Fix TypeScript/export issues before writing components. |
| Turn 6 – Frontend components | Hooks + utils. | Create 11 UI components (layout, sidebar, drive card, image grid/thumbnail, filter sidebar, search bar, pagination, tag pill, add-drive dialog, Vidstack wrapper). | Generic UI building blocks consumed by pages. | `npm run test` or component-level checks; `components/VideoPlayer.tsx` imports Vidstack CSS (per Turn 6 constraints). | Correct missing imports / mismatched props before writing pages. |
| Turn 7 – Frontend pages | Components + API hooks. | Build App Router pages (`/`, `/browse/[id]`, `/images`, `/images/[id]`, `/storage`, `/tags`, `/settings`) plus root layout with `QueryClientProvider` and React Query devtools. | Full UI surfaces wired to API, uses `use-crawler` for real-time updates, `VideoPlayer` for video MIME types. | Validation from Turn 7 (infinite scroll, WebSocket use, metadata editor constraints). | Fix UI runtime errors (e.g., missing `use client` directive) before moving to Turn 8. |
| Turn 8 – Database + e2e | API + Schema + UI + CLI. | Generate `db/schema.sql` from JPA entities (the version stored here), add Docker Compose (expected but missing), write `e2e/*.http` requests. | SQL DDL, e2e test files, `Makefile` ready for dev. | Atl least manual `psql`/`curl` checks or `e2e` runs; validations include UUID columns, Docker Compose mapping to `/docker-entrypoint-initdb.d/` (not yet in repo). | Fix SQL issues, regenerate schema (`ai/agentic pipeline/turns/turn-24/manifest` shows repeated schema work). |

## Execution notes
- Each stage begins with the **session start prompt** from `docs/rebuild-guide.md` so that the agent knows which turn is running.
- Agent outputs for each stage are recorded under `ai/agentic-pipeline/turns/<turn>` (manifest/session_context/pull_request/adr) and indexed in `turns_index.csv`; future automation can replay or audit by reading those files.
- Validation failure handling is manual: rerun the relevant command (`./mvnw`, `npm run build`, `npm run lint`) until the checkbox in `docs/rebuild-guide.md` can be ticked.
- The workflow is entirely sequential (Turn N depends on Turn N-1), so the DAG has no parallel branches; transitions are triggered only after the listed validation commands succeed.
