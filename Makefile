# Generated by agentic-pipeline /makefile-gen
# Stack: nextjs, nestjs, drizzle, shadcn
# Date: 2026-02-25T00:09:24Z

# App directory (all node/pnpm commands run here)
APP_DIR := app

.PHONY: help install dev build test lint typecheck clean
.PHONY: docker-up docker-down docker-logs docker-ps docker-reset
.PHONY: dev-web build-web test-web start-web
.PHONY: dev-api build-api test-api start-api
.PHONY: db-generate db-migrate db-studio db-push db-reset
.PHONY: setup fresh all verify

#===========================================================================
# Help
#===========================================================================

help:
	@echo ""
	@echo "  Makefile for claude-code-configuration"
	@echo "  Stack: nextjs, nestjs, drizzle, shadcn"
	@echo ""
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

#===========================================================================
# Setup
#===========================================================================

install: ## Install all dependencies
	cd $(APP_DIR) && pnpm install

clean: ## Clean build artifacts and node_modules
	rm -rf $(APP_DIR)/node_modules $(APP_DIR)/api/node_modules $(APP_DIR)/web/node_modules
	rm -rf $(APP_DIR)/packages/*/node_modules
	rm -rf $(APP_DIR)/web/.next $(APP_DIR)/api/dist $(APP_DIR)/packages/*/dist
	rm -rf $(APP_DIR)/services/*/target
	rm -rf $(APP_DIR)/.turbo coverage

#===========================================================================
# Development
#===========================================================================

dev: ## Start all services in development mode
	cd $(APP_DIR) && pnpm dev

dev-web: ## Start Next.js development server (port 3000)
	cd $(APP_DIR) && pnpm --filter web dev

dev-api: ## Start NestJS development server (port 3001)
	cd $(APP_DIR) && pnpm --filter api dev

#===========================================================================
# Docker
#===========================================================================

docker-up: ## Start all Docker services (detached)
	cd $(APP_DIR) && docker compose up -d

docker-down: ## Stop all Docker services
	cd $(APP_DIR) && docker compose down

docker-logs: ## Tail logs from all Docker services
	cd $(APP_DIR) && docker compose logs -f

docker-ps: ## Show running Docker services
	cd $(APP_DIR) && docker compose ps

docker-reset: ## Reset Docker (stop + remove volumes + restart)
	cd $(APP_DIR) && docker compose down -v
	cd $(APP_DIR) && docker compose up -d

#===========================================================================
# Database (Drizzle)
#===========================================================================

db-generate: ## Generate Drizzle migrations from schema
	cd $(APP_DIR) && pnpm db:generate

db-migrate: ## Run pending Drizzle migrations
	cd $(APP_DIR) && pnpm db:migrate

db-studio: ## Open Drizzle Studio GUI
	cd $(APP_DIR) && pnpm db:studio

db-push: ## Push schema changes directly (dev only, no migration)
	cd $(APP_DIR) && pnpm --filter database db:push

db-reset: docker-reset db-migrate ## Reset database (drop + recreate + migrate)

#===========================================================================
# Quality
#===========================================================================

test: ## Run all tests
	cd $(APP_DIR) && pnpm test

test-web: ## Run Next.js tests only
	cd $(APP_DIR) && pnpm --filter web test

test-api: ## Run NestJS tests only
	cd $(APP_DIR) && pnpm --filter api test

lint: ## Run ESLint on all packages
	cd $(APP_DIR) && pnpm lint

typecheck: ## Run TypeScript type checking
	cd $(APP_DIR) && pnpm typecheck

verify: lint typecheck test build ## Full verification pipeline

#===========================================================================
# Build
#===========================================================================

build: ## Build all packages for production
	cd $(APP_DIR) && pnpm build

build-web: ## Build Next.js for production
	cd $(APP_DIR) && pnpm --filter web build

build-api: ## Build NestJS for production
	cd $(APP_DIR) && pnpm --filter api build

start-web: ## Start Next.js production server
	cd $(APP_DIR) && pnpm --filter web start

start-api: ## Start NestJS production server
	cd $(APP_DIR) && pnpm --filter api start:prod

#===========================================================================
# Convenience
#===========================================================================

setup: install docker-up db-migrate ## Full setup: install, Docker, migrate

fresh: clean install docker-reset db-migrate ## Fresh start: clean everything, reinstall

all: docker-up dev ## Start Docker and all dev servers
